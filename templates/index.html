<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colab 代理服务</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Fira+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #020617;
            --surface: #0F172A;
            --surface-2: #1E293B;
            --border: #334155;
            --text: #F8FAFC;
            --text-muted: #94A3B8;
            --accent: #22C55E;
            --accent-dim: rgba(34, 197, 94, 0.15);
            --danger: #EF4444;
            --danger-dim: rgba(239, 68, 68, 0.15);
            --blue: #3B82F6;
            --blue-dim: rgba(59, 130, 246, 0.15);
            --radius: 10px;
            --font-sans: 'Fira Sans', -apple-system, sans-serif;
            --font-mono: 'Fira Code', monospace;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        /* Header */
        .header {
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }
        .header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Add Form */
        .add-form {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            align-items: flex-end;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .field input {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: var(--radius);
            outline: none;
            transition: border-color 0.2s;
        }
        .field input:focus {
            border-color: var(--accent);
        }
        .field input::placeholder {
            color: #475569;
        }
        .field-path { flex: 1; }
        .field-port { width: 120px; }
        .field-name { flex: 1; }

        .btn {
            font-family: var(--font-sans);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:active { opacity: 0.8; }
        .btn-primary {
            background: var(--accent);
            color: #052e16;
        }
        .btn-primary:hover { background: #16A34A; }
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 8px;
            border-radius: 6px;
        }
        .btn-ghost:hover { background: var(--surface-2); color: var(--text); }
        .btn-danger {
            background: var(--danger-dim);
            color: var(--danger);
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }

        /* Table */
        .table-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead th {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 14px 20px;
            text-align: left;
            background: var(--surface-2);
            border-bottom: 1px solid var(--border);
        }
        tbody td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.4);
            font-size: 0.875rem;
            vertical-align: middle;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr {
            transition: background 0.15s;
        }
        tbody tr:hover {
            background: rgba(30, 41, 59, 0.5);
        }

        .path-cell {
            font-family: var(--font-mono);
            font-weight: 500;
            color: var(--blue);
        }
        .port-cell {
            font-family: var(--font-mono);
            color: var(--text-muted);
        }
        .name-cell {
            color: var(--text);
        }

        /* Status indicator */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-online .status-dot {
            background: var(--accent);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }
        .status-online { color: var(--accent); }
        .status-offline .status-dot {
            background: #475569;
        }
        .status-offline { color: var(--text-muted); }
        .status-checking .status-dot {
            background: #F59E0B;
            animation: pulse 1.2s ease-in-out infinite;
        }
        .status-checking { color: #F59E0B; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        /* Links */
        .links-cell {
            display: flex;
            gap: 8px;
        }
        .link-pill {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 999px;
            text-decoration: none;
            background: var(--blue-dim);
            color: var(--blue);
            transition: background 0.2s;
        }
        .link-pill:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
        }
        .empty-state p {
            font-size: 0.9rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            font-family: var(--font-sans);
            font-size: 0.8rem;
            padding: 12px 20px;
            border-radius: var(--radius);
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            animation: slideIn 0.3s ease-out;
            max-width: 360px;
        }
        .toast-error { border-color: var(--danger); color: var(--danger); }
        .toast-success { border-color: var(--accent); color: var(--accent); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* SVG icons inline */
        .icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon-lg {
            width: 20px;
            height: 20px;
        }

        /* Quick Deploy Section */
        .section-header {
            margin-top: 48px;
            margin-bottom: 24px;
        }
        .section-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }
        .section-header p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .deploy-form {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: flex-end;
        }
        .field-url { flex: 2; }

        .app-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .app-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: border-color 0.2s;
        }
        .app-card:hover {
            border-color: #475569;
        }

        .app-info {
            flex: 1;
            min-width: 0;
        }
        .app-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        .app-url {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .app-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .app-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .app-status-running {
            background: var(--accent-dim);
            color: var(--accent);
        }
        .app-status-running .status-dot {
            background: var(--accent);
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
        }
        .app-status-stopped {
            background: rgba(71, 85, 105, 0.3);
            color: var(--text-muted);
        }
        .app-status-stopped .status-dot {
            background: #475569;
        }
        .app-status-deploying {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }
        .app-status-deploying .status-dot {
            background: #F59E0B;
            animation: pulse 1.2s ease-in-out infinite;
        }
        .app-status-error {
            background: var(--danger-dim);
            color: var(--danger);
        }
        .app-status-error .status-dot {
            background: var(--danger);
        }

        .port-badge {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--blue-dim);
            color: var(--blue);
        }

        .app-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 6px 14px;
            border-radius: 8px;
        }
        .btn-blue {
            background: var(--blue-dim);
            color: var(--blue);
        }
        .btn-blue:hover { background: rgba(59, 130, 246, 0.25); }
        .btn-warn {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }
        .btn-warn:hover { background: rgba(245, 158, 11, 0.25); }

        /* Log Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            width: 100%;
            max-width: 860px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }
        .log-pre {
            font-family: var(--font-mono);
            font-size: 0.78rem;
            line-height: 1.65;
            color: var(--text-muted);
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .add-form, .deploy-form {
                flex-wrap: wrap;
            }
            .field-path, .field-name, .field-url { min-width: 100%; }
            .field-port { width: 100%; }
            .container { padding: 24px 16px; }
            thead th, tbody td { padding: 10px 12px; }
            .links-cell { flex-direction: column; gap: 4px; }
            .app-card { flex-direction: column; align-items: stretch; }
            .app-actions { justify-content: flex-end; }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Colab 代理服务</h1>
            <p>管理代理路由映射，转发请求到本地服务</p>
        </div>

        <form class="add-form" id="addForm" onsubmit="return addMapping(event)">
            <div class="field field-path">
                <label for="inputPath">映射路径前缀</label>
                <input type="text" id="inputPath" placeholder="/my-service" required pattern="^/[a-zA-Z0-9_-]+$">
            </div>
            <div class="field field-port">
                <label for="inputPort">本地服务端口</label>
                <input type="number" id="inputPort" placeholder="8001" required min="1" max="65535">
            </div>
            <div class="field field-name">
                <label for="inputName">名称（可选）</label>
                <input type="text" id="inputName" placeholder="服务名称">
            </div>
            <button type="submit" class="btn btn-primary">
                <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                添加
            </button>
        </form>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>路径</th>
                        <th>目标</th>
                        <th>名称</th>
                        <th>状态</th>
                        <th>链接</th>
                        <th style="text-align:right">操作</th>
                    </tr>
                </thead>
                <tbody id="mappingsBody">
                </tbody>
            </table>
            <div class="empty-state" id="emptyState" style="display:none;">
                <svg class="icon-lg" viewBox="0 0 24 24" style="width:48px;height:48px;" stroke="currentColor" stroke-width="1.5" fill="none">
                    <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    <path d="M9 10h.01M15 10h.01M9.5 15.5a3.5 3.5 0 015 0"/>
                </svg>
                <p>暂无映射配置，请在上方添加。</p>
            </div>
        </div>
        <!-- Quick Deploy Section -->
        <div class="section-header">
            <h2>快速部署</h2>
            <p>从 Git 仓库一键部署应用到本地</p>
        </div>

        <form class="deploy-form" id="deployForm" onsubmit="return deployApp(event)">
            <div class="field field-url">
                <label for="deployUrl">Git 仓库地址</label>
                <input type="url" id="deployUrl" placeholder="https://github.com/user/repo.git">
            </div>
            <div class="field field-name">
                <label for="deployName">名称（可选）</label>
                <input type="text" id="deployName" placeholder="应用名称">
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                部署
            </button>
        </form>

        <div class="app-grid" id="appGrid"></div>
    </div>

    <!-- Log Modal -->
    <div class="modal-overlay" id="logModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="logModalTitle">应用日志</h3>
                <button class="btn btn-ghost" onclick="closeLogModal()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div class="modal-body" id="logModalBody">
                <pre class="log-pre" id="logContent"></pre>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const API = '/_api/mappings';
        const STORAGE_KEY = 'colab_proxy_mappings';
        let mappings = [];
        let statusCache = {};

        // --- localStorage helpers ---
        function saveToLocal() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(mappings));
            } catch {}
        }

        function loadFromLocal() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch { return []; }
        }

        // Sync localStorage mappings to server (for cold-start restore)
        async function restoreFromLocal(localMappings) {
            let restored = 0;
            for (const m of localMappings) {
                try {
                    const res = await fetch(API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(m)
                    });
                    if (res.ok) restored++;
                } catch {}
            }
            if (restored > 0) {
                toast(`已从本地缓存恢复 ${restored} 条映射`, 'success');
            }
        }

        // Toast notifications
        function toast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = `toast toast-${type}`;
            el.textContent = message;
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 3000);
        }

        // Fetch all mappings
        async function loadMappings() {
            try {
                const res = await fetch(API);
                mappings = await res.json();

                // If server is empty but localStorage has data, auto-restore
                if (mappings.length === 0) {
                    const local = loadFromLocal();
                    if (local.length > 0) {
                        await restoreFromLocal(local);
                        const res2 = await fetch(API);
                        mappings = await res2.json();
                    }
                }

                saveToLocal();
                render();
                checkAllPorts();
            } catch (e) {
                toast('加载映射失败', 'error');
            }
        }

        // Add mapping
        async function addMapping(e) {
            e.preventDefault();
            const path = document.getElementById('inputPath').value.trim();
            const port = parseInt(document.getElementById('inputPort').value);
            const name = document.getElementById('inputName').value.trim() || path.replace('/', '');

            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, port, name })
                });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '添加失败', 'error');
                    return;
                }
                document.getElementById('addForm').reset();
                toast(`已添加 ${path}`, 'success');
                await loadMappings();
            } catch (e) {
                toast('添加映射失败', 'error');
            }
        }

        // Delete mapping
        async function deleteMapping(path) {
            if (!confirm(`确认删除 ${path} 的映射？`)) return;
            try {
                await fetch(`${API}/${encodeURIComponent(path)}`, { method: 'DELETE' });
                toast(`已删除 ${path}`, 'success');
                await loadMappings();
            } catch (e) {
                toast('删除失败', 'error');
            }
        }

        // Check port status
        async function checkPort(path) {
            statusCache[path] = 'checking';
            render();
            try {
                const res = await fetch(`/_api/port-status/${encodeURIComponent(path)}`);
                const data = await res.json();
                statusCache[path] = data.online ? 'online' : 'offline';
            } catch {
                statusCache[path] = 'offline';
            }
            render();
        }

        async function checkAllPorts() {
            const promises = mappings.map(m => checkPort(m.path));
            await Promise.all(promises);
        }

        // Render table
        function render() {
            const tbody = document.getElementById('mappingsBody');
            const empty = document.getElementById('emptyState');

            if (mappings.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            tbody.innerHTML = mappings.map(m => {
                const st = statusCache[m.path] || 'checking';
                const statusLabel = st === 'checking' ? '检测中...' : st === 'online' ? '在线' : '离线';
                return `
                <tr>
                    <td class="path-cell">${escHtml(m.path)}</td>
                    <td class="port-cell">127.0.0.1:${m.port}</td>
                    <td class="name-cell">${escHtml(m.name)}</td>
                    <td>
                        <span class="status status-${st}">
                            <span class="status-dot"></span>
                            ${statusLabel}
                        </span>
                    </td>
                    <td>
                        <div class="links-cell">
                            <a href="${escHtml(m.path)}/" class="link-pill" target="_blank">API</a>
                            <a href="${escHtml(m.path)}/docs" class="link-pill" target="_blank">Docs</a>
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-ghost" onclick="checkPort('${escHtml(m.path)}')" title="刷新状态">
                                <svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                            </button>
                            <button class="btn btn-ghost" onclick="deleteMapping('${escHtml(m.path)}')" title="删除映射" style="color:var(--danger)">
                                <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // Auto-refresh status every 30s
        setInterval(checkAllPorts, 30000);

        // Init
        loadMappings();

        // ============ Quick Deploy ============
        const APPS_API = '/_api/apps';
        let apps = [];
        let logModalAppId = null;
        let logPollInterval = null;

        async function loadApps() {
            try {
                const res = await fetch(APPS_API);
                apps = await res.json();
                renderApps();
            } catch (e) {
                console.error('loadApps error', e);
            }
        }

        async function deployApp(e) {
            e.preventDefault();
            const git_url = document.getElementById('deployUrl').value.trim();
            const name = document.getElementById('deployName').value.trim();
            if (!git_url) { toast('请输入 Git 仓库地址', 'error'); return; }
            try {
                const res = await fetch(`${APPS_API}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ git_url, name })
                });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '部署失败', 'error');
                    return;
                }
                document.getElementById('deployForm').reset();
                toast('正在部署...', 'success');
                await loadApps();
            } catch (e) {
                toast('部署请求失败', 'error');
            }
        }

        async function deployPreset(git_url, name) {
            try {
                const res = await fetch(`${APPS_API}/deploy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ git_url, name })
                });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '部署失败', 'error');
                    return;
                }
                toast('正在部署...', 'success');
                await loadApps();
            } catch (e) {
                toast('部署请求失败', 'error');
            }
        }

        async function startApp(id) {
            try {
                const res = await fetch(`${APPS_API}/${id}/start`, { method: 'POST' });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '启动失败', 'error');
                    return;
                }
                toast('正在启动...', 'success');
                await loadApps();
            } catch (e) {
                toast('启动失败', 'error');
            }
        }

        async function stopApp(id) {
            try {
                const res = await fetch(`${APPS_API}/${id}/stop`, { method: 'POST' });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '停止失败', 'error');
                    return;
                }
                toast('已停止', 'success');
                await loadApps();
            } catch (e) {
                toast('停止失败', 'error');
            }
        }

        async function deleteApp(id) {
            if (!confirm('确认删除此应用？将停止运行并删除目录。')) return;
            try {
                const res = await fetch(`${APPS_API}/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    toast(data.detail || '删除失败', 'error');
                    return;
                }
                toast('已删除', 'success');
                await loadApps();
            } catch (e) {
                toast('删除失败', 'error');
            }
        }

        function openLogModal(id, name) {
            logModalAppId = id;
            document.getElementById('logModalTitle').textContent = `${name} - 日志`;
            document.getElementById('logContent').textContent = '加载中...';
            document.getElementById('logModal').classList.add('open');
            fetchLogs();
            logPollInterval = setInterval(fetchLogs, 2000);
        }

        function closeLogModal() {
            document.getElementById('logModal').classList.remove('open');
            logModalAppId = null;
            if (logPollInterval) { clearInterval(logPollInterval); logPollInterval = null; }
        }

        async function fetchLogs() {
            if (!logModalAppId) return;
            try {
                const res = await fetch(`${APPS_API}/${logModalAppId}/logs?limit=2000`);
                const data = await res.json();
                const pre = document.getElementById('logContent');
                const body = document.getElementById('logModalBody');
                const atBottom = body.scrollTop + body.clientHeight >= body.scrollHeight - 30;
                pre.textContent = data.lines.join('\n') || '（暂无日志）';
                if (atBottom) { body.scrollTop = body.scrollHeight; }
            } catch (e) {
                console.error('fetchLogs error', e);
            }
        }

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLogModal();
        });

        function statusLabel(status) {
            const map = { running: '运行中', stopped: '已停止', deploying: '部署中', error: '错误' };
            return map[status] || status;
        }

        function renderApps() {
            const grid = document.getElementById('appGrid');
            if (apps.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>暂无应用</p></div>';
                return;
            }

            grid.innerHTML = apps.map(a => {
                const deployed = !!a.deployed_at;
                const st = a.status;

                // Build action buttons
                let actions = '';
                if (st === 'stopped' && !deployed) {
                    actions += `<button class="btn btn-primary btn-sm" onclick="deployPreset('${escHtml(a.git_url)}','${escHtml(a.name)}')">部署</button>`;
                } else if (st === 'stopped' && deployed) {
                    actions += `<button class="btn btn-primary btn-sm" onclick="startApp('${escHtml(a.id)}')">启动</button>`;
                    actions += `<button class="btn btn-blue btn-sm" onclick="openLogModal('${escHtml(a.id)}','${escHtml(a.name)}')">日志</button>`;
                    actions += `<button class="btn btn-danger btn-sm" onclick="deleteApp('${escHtml(a.id)}')">删除</button>`;
                } else if (st === 'deploying') {
                    actions += `<button class="btn btn-blue btn-sm" onclick="openLogModal('${escHtml(a.id)}','${escHtml(a.name)}')">日志</button>`;
                } else if (st === 'running') {
                    actions += `<button class="btn btn-warn btn-sm" onclick="stopApp('${escHtml(a.id)}')">停止</button>`;
                    actions += `<button class="btn btn-blue btn-sm" onclick="openLogModal('${escHtml(a.id)}','${escHtml(a.name)}')">日志</button>`;
                } else if (st === 'error') {
                    actions += `<button class="btn btn-primary btn-sm" onclick="deployPreset('${escHtml(a.git_url)}','${escHtml(a.name)}')">重试</button>`;
                    actions += `<button class="btn btn-blue btn-sm" onclick="openLogModal('${escHtml(a.id)}','${escHtml(a.name)}')">日志</button>`;
                    if (deployed) actions += `<button class="btn btn-danger btn-sm" onclick="deleteApp('${escHtml(a.id)}')">删除</button>`;
                }

                // Port badges
                const portBadges = (a.ports || []).map(p => `<span class="port-badge">:${p}</span>`).join('');

                // Quick-open links (only when running with ports)
                const appPath = a.path || ('/' + a.id);
                const hasMapping = st === 'running' && (a.ports || []).length > 0;
                const quickLinks = hasMapping
                    ? `<a href="${escHtml(appPath)}/" class="link-pill" target="_blank">API</a><a href="${escHtml(appPath)}/docs" class="link-pill" target="_blank">Docs</a>`
                    : '';

                return `
                <div class="app-card">
                    <div class="app-info">
                        <div class="app-name">${escHtml(a.name)}${hasMapping ? `<span style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text-muted);margin-left:8px">${escHtml(appPath)}</span>` : ''}</div>
                        <div class="app-url">${escHtml(a.git_url)}</div>
                        <div class="app-meta">
                            <span class="app-status app-status-${st}">
                                <span class="status-dot"></span>
                                ${statusLabel(st)}
                            </span>
                            ${portBadges}
                            ${quickLinks}
                            ${a.error ? `<span style="font-size:0.75rem;color:var(--danger)">${escHtml(a.error)}</span>` : ''}
                        </div>
                    </div>
                    <div class="app-actions">${actions}</div>
                </div>`;
            }).join('');
        }

        // Auto-refresh apps every 10s
        setInterval(loadApps, 10000);

        // Init apps
        loadApps();
    </script>
</body>
</html>
